<html>
  <head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="/geo.css" rel="stylesheet">
  </head>
  <body>
    <div id="businesses"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.2/react-with-addons.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.js"></script>

    <script type="text/jsx">
      BusinessInput = React.createClass({
        getInitialState: function() {
          return {
            businesses: [],
            latitude: 33.1243208,
            longitude: -117.32582479999996
          };
        },

        render: function() {
          return (
            hey
          );
        }
      });
    </script>

    <script type="text/jsx">
      Businesses = React.createClass({
        getInitialState: function() {
          return {
            businesses: [],
            latitude: 33.1243208,
            longitude: -117.32582479999996,
            businessText: "asdf asdf asdf dsf fsa fasrwa wer adfs sadf ewr asdf adsf sdaf rewwea fsdafa\nasdfff  rewqewr"
          };
        },

        onLatitudeChange: function(e) {
          this.setState({latitude: e.target.value});
        },

        onLongitudeChange: function(e) {
          this.setState({longitude: e.target.value});
        },

        onBusinessTextChange: function(e) {
          this.setState({businessText: e.target.value});
        },

        onStoreClick: function(e) {
          var self = this;
          console.log('deleting all businesses');
          $.post('/delete_businesses').always(function(){ self.reload(); });
        },

        onDeleteAllClick: function(e) {
          var self = this;
          console.log('deleting all businesses');
          $.post('/delete_businesses').always(function(){ self.reload(); });
        },

        handleLocation: function(e) {
          e.preventDefault();
          this.reload();
        },

        handleNewBusinesses: function(e) {
          e.preventDefault();
          var self = this;
          var txt = $("#businessText").val();
          console.log('posting new businesses');
          console.log(txt);
          $.post('/new_businesses', {data: txt}).always(function(){ self.reload(); });
        },

        componentDidMount: function() {
          this.reload();
          this.loadBusinessText();
        },

        loadBusinessText: function() {
          console.log('loading business text');
          $.get('/businesses_text.json', function(result) {
            var txt = result.businessText;
            if (this.isMounted()) {
              this.setState({ businessText: txt });
            }
          }.bind(this));
        },

        reload: function() {
          console.log('reloading');
          var params = {"latitude": this.state.latitude, "longitude": this.state.longitude}
          $.get(this.props.source, params, function(result) {
            var collection = result.businesses;
            if (this.isMounted()) {
              this.setState({
                businesses: collection
              });
            }
          }.bind(this));
        },

        render: function() {
          var invisible = { 'display': 'none' }
          collection = this.state.businesses || [];
          if (collection.length !== -1) {
            deleteButton = <button type="button" className="btn btn-danger" onClick={this.onDeleteAllClick}><span className="glyphicon glyphicon-remove"></span> Delete all businesses <span className="badge">{collection.length}</span></button>;
          } else {
            deleteButton = '';
          }
          return (
            <div>
              <b>Set sorting location: </b>
              <form onSubmit={this.handleLocation}>
                <input onChange={this.onLatitudeChange} value={this.state.latitude} />
                <input onChange={this.onLongitudeChange} value={this.state.longitude} />
                <button><span className="glyphicon glyphicon-sort-by-order"></span> Sort</button>
              </form>

              <a href="#" id="inputRef">Add new businesses</a>
              <div id="businessInputs" style={invisible}>
                <form onSubmit={this.handleNewBusinesses}>
                  <textarea id="businessText" className="big-box" onChange={this.onBusinessTextChange} value={this.state.businessText} />
                  <br/>
                  <button type="button" className="btn btn-success" onClick={this.handleNewBusinesses}><span className="glyphicon glyphicon-ok"></span> Store Businesses</button>
                </form>
              </div>
              <hr/>

              <h1>Business Locations</h1>
              <div className="container shadow">
                <div className="row headingRow">
                  <div className="col-md-2">Name</div>
                  <div className="col-md-2">Street</div>
                  <div className="col-md-2">Zip</div>
                  <div className="col-md-2">Latitude</div>
                  <div className="col-md-2">Longitude</div>
                  <div className="col-md-2">Distance</div>
                </div>
                {collection.map(function(business) {
                  return <div className="row">
                    <div className="col-md-2">{business.name}</div>
                    <div className="col-md-2">{business.street}</div>
                    <div className="col-md-2">{business.zip}</div>
                    <div className="col-md-2">{business.latitude}</div>
                    <div className="col-md-2">{business.longitude}</div>
                    <div className="col-md-2">{business.distance}</div>
                  </div>
                })}
              </div>
              <br/>
              {deleteButton}
            <button type="button" className="btn btn-danger" onClick={this.handleNewBusinesses}><span className="glyphicon glyphicon-remove"></span> add new businesses <span className="badge">{collection.length}</span></button>;
            </div>
          );
        }
      })

      React.render(
        <Businesses source="/businesses.json" />,
        document.getElementById('businesses')
      );
$("#inputRef").click(function(){ $("#businessInputs").toggle() });
    </script>
  </body>
</html>

